@page "/bike"
@using System.Net.Http.Json
@using eBike.Web.Data
@using Dapr.Client
@inject IJSRuntime jsRuntime
@using BrowserInterop.Extensions
@using BrowserInterop.Geolocation

<h3>eBike</h3>

<EditForm OnSubmit="@SubmitAsync" class="form" Model="User">
    <div class="form-group">
        <label for="name">Name:</label>
        <InputText @bind-Value="@User.Name" DisplayName="Name" id="name"></InputText>
    </div>
     <div class="form-group">
        <label for="surname">Surname:</label>
        <InputText @bind-Value="@User.Surname" DisplayName="Surname" id="surname"></InputText>
    </div>
    <divider></divider>
    <div class="form-group">
        <label for="bike-name">Bike Name:</label>
        <InputText @bind-Value="@User.Bike.Name" DisplayName="Bike Name" id="bike-name"></InputText>
    </div>
    <button type="submit" class="btn btn-primary">Confirm</button>
</EditForm>

@code {
    [Inject]
    public DaprClient DaprClient { get; set; }
    public UserInsertViewModel User { get; set; } = new UserInsertViewModel();

    private WindowNavigatorGeolocation geolocationWrapper;
    private GeolocationPosition currentPosition;
    protected override async Task OnInitializedAsync(){
        var window = await jsRuntime.Window();
        var navigator = await window.Navigator();
        geolocationWrapper = navigator.Geolocation;
    }

    public async Task SubmitAsync ()
    {
        currentPosition = (await geolocationWrapper.GetCurrentPosition(new PositionOptions()
        {
            EnableHighAccuracy = true,
            MaximumAgeTimeSpan = TimeSpan.FromHours(1),
            TimeoutTimeSpan = TimeSpan.FromMinutes(1)
        })).Location;

        User.Bike.Longitude = currentPosition.Coords.Longitude;
        User.Bike.Latitude = currentPosition.Coords.Latitude;

        var request = DaprClient.CreateInvokeMethodRequest("ebike.aggregator.bff", "/v1/Bikes/new-user-bike");
        request.Content = JsonContent.Create(User);
       
        var response = await DaprClient.InvokeMethodWithResponseAsync(request);
        var r = response.Content.ReadFromJsonAsync<AggregatorResponseUserBike>();
    }
}
